<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-03-31T12:38:30.5801715"><title>Обслуживание (MAINTENANCE) | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"f3dfst_178","level":0,"title":"Обновление статистики для таблицы","anchor":"#f3dfst_178"},{"id":"f3dfst_215","level":0,"title":"Размер таблицы","anchor":"#f3dfst_215"},{"id":"vacuumtable","level":0,"title":"Реорганизация таблицы с Vacuum","anchor":"#vacuumtable"},{"id":"vacuum_full","level":0,"title":"Реорганизация таблицы с Vacuum Full","anchor":"#vacuum_full"},{"id":"vacuum","level":0,"title":"Когда был Vacuum для таблицы","anchor":"#vacuum"},{"id":"auto-vacuum","level":0,"title":"Включение отключение AUTO Vacuum для таблицы","anchor":"#auto-vacuum"},{"id":"auto-vacuum_1","level":0,"title":"Опции AUTO Vacuum для таблиц","anchor":"#auto-vacuum_1"},{"id":"vacuum_1","level":0,"title":"Мониторинг vacuum операций","anchor":"#vacuum_1"},{"id":"autovacuum","level":0,"title":"Управление autovacuum","anchor":"#autovacuum"},{"id":"rebuild-index","level":0,"title":"Rebuild index","anchor":"#rebuild-index"},{"id":"index-create-rebuild","level":0,"title":"Мониторинг создания индексов (index create, rebuild)","anchor":"#index-create-rebuild"},{"id":"f3dfst_257","level":0,"title":"Статистика для колонки таблицы","anchor":"#f3dfst_257"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.css" rel="stylesheet"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Обслуживание (MAINTENANCE) | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/howto-maintance.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Обслуживание (MAINTENANCE) | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/howto-maintance.html#webpage",
    "url": "writerside-documentation/howto-maintance.html",
    "name": "Обслуживание (MAINTENANCE) | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="howto-maintance" data-main-title="Обслуживание (MAINTENANCE)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="pjstgres-resourcesl.md|Ресурсы///How-to.md|Советы"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="howto-maintance" id="howto-maintance.md">Обслуживание (MAINTENANCE)</h1><section class="chapter"><h2 id="f3dfst_178" data-toc="f3dfst_178">Обновление статистики для таблицы</h2><p id="f3dfst_179">Анализ таблицы</p><div class="code-block" data-lang="sql">
analyze public.testidx;
</div><p id="f3dfst_181">Анализ указанных колонок</p><div class="code-block" data-lang="sql">
analyze public.testidx (state,created_at);
</div><p id="f3dfst_183">Когда был проведен анализ</p><div class="code-block" data-lang="sql">
select schemaname, relname, analyze_count, last_analyze, last_autoanalyze
from pg_stat_user_tables
where relname in ('testidx', 'testnoidx');
</div><p id="f3dfst_185">Пример результата:</p><div class="table-wrapper"><table class="wide" id="f3dfst_186"><thead><tr class="ijRowHead" id="f3dfst_187"><th id="f3dfst_188"><p>schemaname</p></th><th id="f3dfst_189"><p>relname</p></th><th id="f3dfst_190"><p>analyze_count</p></th><th id="f3dfst_191"><p>last_analyze</p></th><th id="f3dfst_192"><p>last_autoanalyze</p></th></tr></thead><tbody><tr id="f3dfst_193"><td id="f3dfst_194"><p>public</p></td><td id="f3dfst_195"><p>testidx</p></td><td id="f3dfst_196"><p>5</p></td><td id="f3dfst_197"><p>2024-03-25 07:02:09.149396 +03:00</p></td><td id="f3dfst_198"><p>2024-03-19 22:47:29.390729 +03:00</p></td></tr><tr id="f3dfst_199"><td id="f3dfst_200"><p>public</p></td><td id="f3dfst_201"><p>testnoidx</p></td><td id="f3dfst_202"><p>3</p></td><td id="f3dfst_203"><p>2024-03-23 05:59:07.183202 +03:00</p></td><td id="f3dfst_204"><p>2024-03-19 22:53:58.156683 +03:00</p></td></tr></tbody></table></div><p id="f3dfst_205">Анализ с verbose</p><div class="code-block" data-lang="sql">
analyze verbose public.testidx (state,created_at);
</div><p id="f3dfst_207">Анализ по всей базе</p><div class="code-block" data-lang="sql">
analyze;
</div><aside class="prompt" data-type="note" data-title="" id="f3dfst_209"><p id="f3dfst_210">Для analyze требуется блокировка только на чтение</p></aside><p id="f3dfst_211"><a href="https://postgrespro.ru/docs/postgrespro/16/progress-reporting#ANALYZE-PROGRESS-REPORTING" id="f3dfst_212" data-external="true" rel="noopener noreferrer">Анализ выполнения операции analyze...</a></p><p id="f3dfst_213"><a href="https://postgrespro.ru/search/?q=set+statistics&amp;area=version&amp;product=postgrespro&amp;version=16" id="f3dfst_214" data-external="true" rel="noopener noreferrer">еще про статистику...</a></p></section><section class="chapter"><h2 id="f3dfst_215" data-toc="f3dfst_215">Размер таблицы</h2><div class="code-block" data-lang="sql">
select pg_size_pretty(pg_relation_size('public.testidx'));
</div></section><section class="chapter"><h2 id="vacuumtable" data-toc="vacuumtable">Реорганизация таблицы с Vacuum</h2><aside class="prompt" data-type="note" data-title="" id="f3dfst_217"><p id="f3dfst_218">Операция не возвращает место на диске!</p></aside><div class="code-block" data-lang="sql">
vacuum public.testtblData;
</div><div class="code-block" data-lang="sql">
vacuum analyze public.testtblData;
</div><div class="code-block" data-lang="sql">
vacuum verbose analyze public.testtblData;
</div><p id="f3dfst_222">Мониторинг vacuum</p><div class="code-block" data-lang="sql">
select * from pg_stat_progress_vacuum
</div><p id="f3dfst_224">Данные для таблицы</p><div class="code-block" data-lang="sql">
select schemaname,relname,last_vacuum,vacuum_count 
from pg_stat_user_tables where relname='emptab';
</div></section><section class="chapter"><h2 id="vacuum_full" data-toc="vacuum_full">Реорганизация таблицы с Vacuum Full</h2><aside class="prompt" data-type="note" data-title="" id="f3dfst_226"><p id="f3dfst_227">Операция возвращает место на диске!</p></aside><div class="code-block" data-lang="sql">
vacuum full public.testtblData;
</div><p id="f3dfst_229">vacuum full - операция для сжатия данных. Для проверки:</p><div class="code-block" data-lang="sql">
drop table if exists public.testtblData;
-- public.testidx - достаточно большая таблица
create table public.testtblData as table public.testidx;
-- объесм данных
select pg_size_pretty(pg_relation_size('public.testtblData')); --1030 MB
select count(*) from public.testtblData; --11 633 001
delete from public.testtblData where id&lt;5000000;
select count(*) from public.testtblData; --6 633 003
select pg_size_pretty(pg_relation_size('public.testtblData')); --1030 MB
vacuum full public.testtblData;
select pg_size_pretty(pg_relation_size('public.testtblData')); --550 MB
</div></section><section class="chapter"><h2 id="vacuum" data-toc="vacuum">Когда был Vacuum для таблицы</h2><div class="code-block" data-lang="sql">
select * from pg_stat_user_tables where relname='test'
</div></section><section class="chapter"><h2 id="auto-vacuum" data-toc="auto-vacuum">Включение отключение AUTO Vacuum для таблицы</h2><div class="code-block" data-lang="sql">
alter table test2 set( autovacuum_enabled = off);
</div><div class="code-block" data-lang="sql">
alter table test2 set( autovacuum_enabled = on);
</div></section><section class="chapter"><h2 id="auto-vacuum_1" data-toc="auto-vacuum_1">Опции AUTO Vacuum для таблиц</h2><div class="code-block" data-lang="sql">
select n.nspname,
       c.relname,
       pg_catalog.array_to_string(c.reloptions || array(
           select 'toast.' ||
                      x
               from pg_catalog.unnest(tc.reloptions) x), ', ')
           as relopts
from pg_catalog.pg_class c
         left join
     pg_catalog.pg_class tc on (c.reltoastrelid = tc.oid)
         inner join
     pg_namespace n on c.relnamespace = n.oid
where c.relkind = 'r'
  and nspname not in ('pg_catalog', 'information_schema');
</div></section><section class="chapter"><h2 id="vacuum_1" data-toc="vacuum_1">Мониторинг vacuum операций</h2><div class="code-block" data-lang="sql">
select * from pg_stat_progress_vacuum;
</div></section><section class="chapter"><h2 id="autovacuum" data-toc="autovacuum">Управление autovacuum</h2><p id="f3dfst_236">Включен или выключен automacuum:</p><div class="code-block" data-lang="sql">
select name, setting, short_desc, boot_val, pending_restart
from pg_settings
where name in ('autovacuum', 'track_counts');
</div><p id="f3dfst_238">Дополнительные опции autovacuum:</p><div class="code-block" data-lang="sql">
select name,
       setting,
       short_desc,
       min_val,
       max_val,
       enumvals,
       boot_val,
       pending_restart
from pg_settings
where category like 'Autovacuum';
</div><p id="f3dfst_240">Изменение опций autovacuum:</p><div class="code-block" data-lang="sql">
alter system set autovacuum_max_workers=10 ;
</div><aside class="prompt" data-type="warning" data-title="" id="f3dfst_242"><p id="f3dfst_243">Требуется рестарт!</p></aside></section><section class="chapter"><h2 id="rebuild-index" data-toc="rebuild-index">Rebuild index</h2><p id="f3dfst_244">Перестроение одного индекса:</p><div class="code-block" data-lang="sql">
reindex index testidx_pk;
-- или с указанием схемы
reindex index public.testidx_pk;
</div><p id="f3dfst_246">Перестроение всех индексов таблицы:</p><div class="code-block" data-lang="sql">
-- 
reindex table public.testidx;
</div><p id="f3dfst_248">Перестроение свех индексов в схеме</p><div class="code-block" data-lang="sql">
reindex schema public;
</div><p id="f3dfst_250">Перестроение всех индексов в базе:</p><div class="code-block" data-lang="sql">
reindex database devtestindex
</div><p id="f3dfst_252">Перестроение с опцией verbose. Вывод дополнительных сообщений</p><div class="code-block" data-lang="sql">
reindex (verbose) table public.testidx;
</div><p id="f3dfst_254">Перестроение без блокировки:</p><div class="code-block" data-lang="sql">
reindex (verbose) table concurrently public.testidx;
</div></section><section class="chapter"><h2 id="index-create-rebuild" data-toc="index-create-rebuild">Мониторинг создания индексов (index create, rebuild)</h2><div class="code-block" data-lang="sql">
select a.query, p.phase, p.blocks_total, p.blocks_done, p.tuples_total, p.tuples_done
from pg_stat_progress_create_index p
         inner join pg_stat_activity a on p.pid = a.pid;

select pid,
       datname,
       command,
       phase,
       tuples_total,
       tuples_done,
       partitions_total,
       partitions_done
from pg_stat_progress_create_index;
</div></section><section class="chapter"><h2 id="f3dfst_257" data-toc="f3dfst_257">Статистика для колонки таблицы</h2><p id="f3dfst_258">Структура таблицы:</p><div class="code-block" data-lang="sql">
create table public.teststat
(
    id         bigint generated by default as identity
        primary key,
    fk_id      bigint
        references public.teststat,
    state      text,
    amount     numeric,
    item       text,
    created_at timestamp(6) with time zone
);
</div><p id="f3dfst_260">данные о статистике:</p><div class="code-block" data-lang="sql">
select attname as column_name, attstattarget as stats_level
from pg_attribute
where attrelid = (select oid from pg_class where relname = 'teststat')
  and attname = 'item';
</div><p id="f3dfst_262">изменение статистики: где 100 означает 1 процент,10000 означает 100 процентов, -1 = по умолчанию</p><div class="code-block" data-lang="sql">
alter table teststat alter column item set statistics 1000;
</div></section><div class="last-modified">Last modified: 31 марта 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="howto-temptablespases.html" class="navigation-links__prev">Простраство temp_tablespaces</a><a href="howto-monitor.html" class="navigation-links__next">Мониторинг запросов</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.js"></script></body></html>