<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-05-15T09:21:07.5351025"><title>Логическое удаление | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"deleted-by","level":0,"title":"Использование дополнения deleted_by","anchor":"#deleted-by"},{"id":"-tit3m5_242","level":0,"title":"Использование дополнительной таблицы для истории состояния","anchor":"#-tit3m5_242"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="frontend/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="icon" type="image/png" sizes="32x32" href="writerside_32.png"><link rel="icon" type="image/png" sizes="64x64" href="writerside_64.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Логическое удаление | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/database-desing-deleteby.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Логическое удаление | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/database-desing-deleteby.html#webpage",
    "url": "writerside-documentation/database-desing-deleteby.html",
    "name": "Логическое удаление | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="database-desing-deleteby" data-main-title="Логическое удаление" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Default-topic.md|Postgres - полезные ресурсы, руководства подсказки, советы///db-design.md|Проектирование баз данных"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="database-desing-deleteby" id="database-desing-deleteby.md">Логическое удаление</h1><p id="-tit3m5_194">Принцип логического удаления данные применяют достаточно часто. В большинстве случаев для этого применяют не просто логический флаг для записи &quot;удалена/активна&quot;, а в более расширенном виде таблицы текущих состояний и соответствующего столбца <span class="control" id="-tit3m5_195">StateId</span> в основной таблице.</p><figure id="-tit3m5_196"><img alt="sample_states_products.png" src="images/sample_states_products.png" title="sample_states_products.png" width="733" height="674"></figure><div class="code-block" data-lang="sql">
create table public.states
(
    id integer generated by default as identity
        constraint states_pk primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';

comment on column public.states.state_name is 'Наименование';

comment on column public.states.state_memo is 'Описание';
</div><p id="-tit3m5_198">Пример возможных значений:</p><div class="table-wrapper"><table class="wide" id="-tit3m5_199"><thead><tr class="ijRowHead" id="-tit3m5_200"><th id="-tit3m5_201"><p>id</p></th><th id="-tit3m5_202"><p>state_name</p></th><th id="-tit3m5_203"><p>state_memo</p></th></tr></thead><tbody><tr id="-tit3m5_204"><td id="-tit3m5_205"><p>1</p></td><td id="-tit3m5_206"><p>Неактивно</p></td><td id="-tit3m5_207"><p>null</p></td></tr><tr id="-tit3m5_208"><td id="-tit3m5_209"><p>2</p></td><td id="-tit3m5_210"><p>Активно</p></td><td id="-tit3m5_211"><p>null</p></td></tr><tr id="-tit3m5_212"><td id="-tit3m5_213"><p>3</p></td><td id="-tit3m5_214"><p>Требуется коректировка</p></td><td id="-tit3m5_215"><p>null</p></td></tr></tbody></table></div><p id="-tit3m5_216">Для удаленных состояний можно применять как собственное значение, например:</p><ul class="list _bullet" id="-tit3m5_217"><li class="list__item" id="-tit3m5_218"><p><span class="control" id="-tit3m5_219">-1</span> - соответствует значению удалена</p></li><li class="list__item" id="-tit3m5_220"><p>как &quot;текущее состояние + 100&quot;,т.е. 101 - соответствует &quot;была неактивна и удалена&quot;, 102 - &quot;была активна и удалена&quot;</p></li></ul><section class="chapter"><h2 id="deleted-by" data-toc="deleted-by">Использование дополнения deleted_by</h2><p id="-tit3m5_221">В некоторых случаях будет полезным использовать в таблице соответствующих столбцов для ведения дополнительной аналитики:</p><ul class="list _bullet" id="-tit3m5_222"><li class="list__item" id="-tit3m5_223"><p><span class="control" id="-tit3m5_224">deleted_by</span> - ссылка на пользователя/или текст, кем удалена</p></li><li class="list__item" id="-tit3m5_225"><p><span class="control" id="-tit3m5_226">deleted_on</span> или <span class="control" id="-tit3m5_227">deleted_at</span> - дата/время, когда удалена</p></li></ul><p id="-tit3m5_228">Данные столбцы полезны только при отсутствии в таблице столбцов отвечающих за состояние <span class="control" id="-tit3m5_229">StateId</span>, <span class="control" id="-tit3m5_230">updated_at</span>, так как данные столбцы полностью покрывают информацию столбца deleted_on</p><aside class="prompt" data-type="tip" data-title="" id="-tit3m5_231"><p id="-tit3m5_232">При использовании столбцов <span class="control" id="-tit3m5_233">deleted_on</span> и <span class="control" id="-tit3m5_234">StateId</span> желательно предусмотреть правильное ограничение, учитывающее, что при наличии данных в столбце <span class="control" id="-tit3m5_235">deleted_on</span> значения в столбце <span class="control" id="-tit3m5_236">StateId</span> должно соответствовать только &quot;удаленным&quot; состояниям.</p></aside><aside class="prompt" data-type="tip" data-title="" id="-tit3m5_237"><p id="-tit3m5_238">Столбец <span class="control" id="-tit3m5_239">deleted_on</span> такжн может оказаться очень полезным для ETL процессов, например для исключения необходимости обновления данных для уже удаленных строк</p></aside><aside class="prompt" data-type="tip" data-title="" id="-tit3m5_240"><p id="-tit3m5_241">Реализация &quot;состояний&quot; - не всегда является простой задачей и может представлять достаточно сложную в реализации при необходимости реализации &quot;состояния с учетом времени&quot;.</p></aside></section><section class="chapter"><h2 id="-tit3m5_242" data-toc="-tit3m5_242">Использование дополнительной таблицы для истории состояния</h2><p id="-tit3m5_243">Для более правильного подхода к реализации &quot;состояния записи&quot; и логического удаления можно использовать дополнительную таблицу &quot;История состояния&quot;.</p><p id="-tit3m5_244">Принцип данного подхода - наличие необходимых (нужных вам) столбцов в основной таблице</p><ul class="list _bullet" id="-tit3m5_245"><li class="list__item" id="-tit3m5_246"><p><span class="control" id="-tit3m5_247">StateId</span> - текущее состояние</p></li><li class="list__item" id="-tit3m5_248"><p><span class="control" id="-tit3m5_249">create_at</span> - дата создания</p></li><li class="list__item" id="-tit3m5_250"><p><span class="control" id="-tit3m5_251">update_at</span> - дата обновления</p></li><li class="list__item" id="-tit3m5_252"><p><span class="control" id="-tit3m5_253">created_by</span> - кем создана</p></li><li class="list__item" id="-tit3m5_254"><p><span class="control" id="-tit3m5_255">updated_by</span> - кем обновлена</p></li></ul><p id="-tit3m5_256">И наличие дополнительной таблицы со столбцами</p><ul class="list _bullet" id="-tit3m5_257"><li class="list__item" id="-tit3m5_258"><p><span class="control" id="-tit3m5_259">pk</span> - идентификатор записи</p></li><li class="list__item" id="-tit3m5_260"><p><span class="control" id="-tit3m5_261">source_id</span> - ссылка на ключ исходной таблицы</p></li><li class="list__item" id="-tit3m5_262"><p><span class="control" id="-tit3m5_263">logdate</span> - фактическая дата протоколирования, которое будет соответствовать значениям столбцов <span class="control" id="-tit3m5_264">create_at</span>, <span class="control" id="-tit3m5_265">update_at</span></p></li><li class="list__item" id="-tit3m5_266"><p><span class="control" id="-tit3m5_267">stateId</span> - идентификатор состояния</p></li><li class="list__item" id="-tit3m5_268"><p><span class="control" id="-tit3m5_269">uid_key</span> - пользователь, кем выполнено действие</p></li></ul><figure id="-tit3m5_270"><img alt="sample_states_productsv2.png" src="images/sample_states_productsv2.png" title="sample_states_productsv2.png" width="1770" height="884"></figure><p id="-tit3m5_271">Для состояния соответствующему фактическому физическому удалению необходимо предусмотреть соответствующее значение, например <span class="control" id="-tit3m5_272">-1</span> - это физическое удаление.</p><section class="chapter"><h3 id="-tit3m5_273" data-toc="-tit3m5_273">Пример работы с таблицей состояний</h3><p id="-tit3m5_274">Создание таблиц и заполнение данными</p><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.states">
create table public.states
(
    id         integer generated by default as identity
        constraint states_pk
            primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';
comment on column public.states.state_name is 'Наименование состояния';
comment on column public.states.state_memo is 'Описание';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2">
create table public.productsv2
(
    id           integer generated by default as identity
        constraint productsv2_pk
            primary key,
    state        integer                                            not null
        constraint productsv2_states_id_fk
            references public.states,
    product_name text                                               not null,
    created_at   timestamp with time zone default CURRENT_TIMESTAMP not null,
    updated_at   timestamp with time zone
);

comment on column public.productsv2.id is 'Идентификатор';
comment on column public.productsv2.state is 'Идентификатор состояния';
comment on column public.productsv2.product_name is 'Наименование';
comment on column public.productsv2.created_at is 'Дата создания';
comment on column public.productsv2.updated_at is 'Дата обновления';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2_states">
create table public.productsv2_states
(
    id         integer generated by default as identity
        constraint pk_productsv2_states_id
            primary key,
    product_id integer                                            not null,
    logdate    timestamp with time zone default CURRENT_TIMESTAMP not null,
    state      integer                                            not null
        constraint fk_productsv2_states_states
            references public.states
);

comment on table public.productsv2_states is 'История состояний для товаров';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="insert into public.states (id, state_name, state_memo)">
insert into public.states (id, state_name, state_memo)
values  (1, 'Неактивно', null),
        (2, 'Активно', null),
        (3, 'Требуется коректировка', null),
        (103, 'Требуется коректировка', 'Логическое удаление'),
        (102, 'Активно', 'Логическое удаление'),
        (-1, 'Удалено', 'Физическое удаление'),
        (101, 'Неактивно', 'Логическое удаление');
</div><p id="-tit3m5_279">Создание новых данных</p><div class="code-block" data-lang="sql">
-- Очистка данных
delete from public.productsv2;
delete from public.productsv2_states;

-- создание новых данных
begin;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with inserted as(
insert into public.productsv2(id, state, product_name)
values  (1, 1, 'Товар1'),
        (2, 1, 'Товар2'),
        (3, 3, 'Товар3 с незаполненными даными'),
        (4, 2, 'Товар4'),
        (5, 2, 'Товар5')
returning id, state, created_at)
insert into _tmpdataStates(id, state, logdate) select id, state, created_at from inserted;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;

commit;
</div><p id="-tit3m5_281">Обновление данных</p><div class="code-block" data-lang="sql">
-- Обновление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = 2,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="-tit3m5_283">Логическое удаление данных</p><div class="code-block" data-lang="sql">
-- логическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = case when state&lt;100 then state+100 else state end,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="-tit3m5_285">Физическое удаление</p><div class="code-block" data-lang="sql">
-- физическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    delete from public.productsv2 where id=1
returning id)
insert into _tmpdataStates(id, state, logdate) select id, -1, CURRENT_TIMESTAMP from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="-tit3m5_287">Просмотр истории состояния</p><div class="code-block" data-lang="sql">
select p.*, p2s.logdate as log_date, p2s.state as log_state
from public.productsv2 p left join public.productsv2_states p2s on p.id = p2s.product_id
order by p.id, logdate desc;

select * from productsv2_states st where state=-1;
</div></section></section><div class="last-modified">Last modified: 15 мая 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="database-desing-updateby.html" class="navigation-links__prev">Применение столбцов updated_by и created_by</a><a href="database-desing-updateby-external.html" class="navigation-links__next">Данные о действиях в отдельной таблице</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="frontend/app.js"></script></body></html>