<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-06-08T10:04:59.2248604"><title>Логическое удаление | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"deleted-by","level":0,"title":"Использование дополнения deleted_by","anchor":"#deleted-by"},{"id":"ktu7m0_50","level":0,"title":"Использование дополнительной таблицы для истории состояния","anchor":"#ktu7m0_50"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="frontend/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="icon" type="image/png" sizes="32x32" href="writerside_32.png"><link rel="icon" type="image/png" sizes="64x64" href="writerside_64.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Логическое удаление | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/database-desing-deleteby.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Логическое удаление | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/database-desing-deleteby.html#webpage",
    "url": "writerside-documentation/database-desing-deleteby.html",
    "name": "Логическое удаление | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="database-desing-deleteby" data-main-title="Логическое удаление" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Default-topic.md|Postgres - полезные ресурсы, руководства подсказки, советы///db-design.md|Проектирование баз данных"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="database-desing-deleteby" id="database-desing-deleteby.md">Логическое удаление</h1><p id="ktu7m0_2">Принцип логического удаления данные применяют достаточно часто. В большинстве случаев для этого применяют не просто логический флаг для записи &quot;удалена/активна&quot;, а в более расширенном виде таблицы текущих состояний и соответствующего столбца <span class="control" id="ktu7m0_3">StateId</span> в основной таблице.</p><figure id="ktu7m0_4"><img alt="sample_states_products.png" src="images/sample_states_products.png" title="sample_states_products.png" width="733" height="674"></figure><div class="code-block" data-lang="sql">
create table public.states
(
    id integer generated by default as identity
        constraint states_pk primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';

comment on column public.states.state_name is 'Наименование';

comment on column public.states.state_memo is 'Описание';
</div><p id="ktu7m0_6">Пример возможных значений:</p><div class="table-wrapper"><table class="wide" id="ktu7m0_7"><thead><tr class="ijRowHead" id="ktu7m0_8"><th id="ktu7m0_9"><p>id</p></th><th id="ktu7m0_10"><p>state_name</p></th><th id="ktu7m0_11"><p>state_memo</p></th></tr></thead><tbody><tr id="ktu7m0_12"><td id="ktu7m0_13"><p>1</p></td><td id="ktu7m0_14"><p>Неактивно</p></td><td id="ktu7m0_15"><p>null</p></td></tr><tr id="ktu7m0_16"><td id="ktu7m0_17"><p>2</p></td><td id="ktu7m0_18"><p>Активно</p></td><td id="ktu7m0_19"><p>null</p></td></tr><tr id="ktu7m0_20"><td id="ktu7m0_21"><p>3</p></td><td id="ktu7m0_22"><p>Требуется коректировка</p></td><td id="ktu7m0_23"><p>null</p></td></tr></tbody></table></div><p id="ktu7m0_24">Для удаленных состояний можно применять как собственное значение, например:</p><ul class="list _bullet" id="ktu7m0_25"><li class="list__item" id="ktu7m0_26"><p><span class="control" id="ktu7m0_27">-1</span> - соответствует значению удалена</p></li><li class="list__item" id="ktu7m0_28"><p>как &quot;текущее состояние + 100&quot;,т.е. 101 - соответствует &quot;была неактивна и удалена&quot;, 102 - &quot;была активна и удалена&quot;</p></li></ul><section class="chapter"><h2 id="deleted-by" data-toc="deleted-by">Использование дополнения deleted_by</h2><p id="ktu7m0_29">В некоторых случаях будет полезным использовать в таблице соответствующих столбцов для ведения дополнительной аналитики:</p><ul class="list _bullet" id="ktu7m0_30"><li class="list__item" id="ktu7m0_31"><p><span class="control" id="ktu7m0_32">deleted_by</span> - ссылка на пользователя/или текст, кем удалена</p></li><li class="list__item" id="ktu7m0_33"><p><span class="control" id="ktu7m0_34">deleted_on</span> или <span class="control" id="ktu7m0_35">deleted_at</span> - дата/время, когда удалена</p></li></ul><p id="ktu7m0_36">Данные столбцы полезны только при отсутствии в таблице столбцов отвечающих за состояние <span class="control" id="ktu7m0_37">StateId</span>, <span class="control" id="ktu7m0_38">updated_at</span>, так как данные столбцы полностью покрывают информацию столбца deleted_on</p><aside class="prompt" data-type="tip" data-title="" id="ktu7m0_39"><p id="ktu7m0_40">При использовании столбцов <span class="control" id="ktu7m0_41">deleted_on</span> и <span class="control" id="ktu7m0_42">StateId</span> желательно предусмотреть правильное ограничение, учитывающее, что при наличии данных в столбце <span class="control" id="ktu7m0_43">deleted_on</span> значения в столбце <span class="control" id="ktu7m0_44">StateId</span> должно соответствовать только &quot;удаленным&quot; состояниям.</p></aside><aside class="prompt" data-type="tip" data-title="" id="ktu7m0_45"><p id="ktu7m0_46">Столбец <span class="control" id="ktu7m0_47">deleted_on</span> такжн может оказаться очень полезным для ETL процессов, например для исключения необходимости обновления данных для уже удаленных строк</p></aside><aside class="prompt" data-type="tip" data-title="" id="ktu7m0_48"><p id="ktu7m0_49">Реализация &quot;состояний&quot; - не всегда является простой задачей и может представлять достаточно сложную в реализации при необходимости реализации &quot;состояния с учетом времени&quot;.</p></aside></section><section class="chapter"><h2 id="ktu7m0_50" data-toc="ktu7m0_50">Использование дополнительной таблицы для истории состояния</h2><p id="ktu7m0_51">Для более правильного подхода к реализации &quot;состояния записи&quot; и логического удаления можно использовать дополнительную таблицу &quot;История состояния&quot;.</p><p id="ktu7m0_52">Принцип данного подхода - наличие необходимых (нужных вам) столбцов в основной таблице</p><ul class="list _bullet" id="ktu7m0_53"><li class="list__item" id="ktu7m0_54"><p><span class="control" id="ktu7m0_55">StateId</span> - текущее состояние</p></li><li class="list__item" id="ktu7m0_56"><p><span class="control" id="ktu7m0_57">create_at</span> - дата создания</p></li><li class="list__item" id="ktu7m0_58"><p><span class="control" id="ktu7m0_59">update_at</span> - дата обновления</p></li><li class="list__item" id="ktu7m0_60"><p><span class="control" id="ktu7m0_61">created_by</span> - кем создана</p></li><li class="list__item" id="ktu7m0_62"><p><span class="control" id="ktu7m0_63">updated_by</span> - кем обновлена</p></li></ul><p id="ktu7m0_64">И наличие дополнительной таблицы со столбцами</p><ul class="list _bullet" id="ktu7m0_65"><li class="list__item" id="ktu7m0_66"><p><span class="control" id="ktu7m0_67">pk</span> - идентификатор записи</p></li><li class="list__item" id="ktu7m0_68"><p><span class="control" id="ktu7m0_69">source_id</span> - ссылка на ключ исходной таблицы</p></li><li class="list__item" id="ktu7m0_70"><p><span class="control" id="ktu7m0_71">logdate</span> - фактическая дата протоколирования, которое будет соответствовать значениям столбцов <span class="control" id="ktu7m0_72">create_at</span>, <span class="control" id="ktu7m0_73">update_at</span></p></li><li class="list__item" id="ktu7m0_74"><p><span class="control" id="ktu7m0_75">stateId</span> - идентификатор состояния</p></li><li class="list__item" id="ktu7m0_76"><p><span class="control" id="ktu7m0_77">uid_key</span> - пользователь, кем выполнено действие</p></li></ul><figure id="ktu7m0_78"><img alt="sample_states_productsv2.png" src="images/sample_states_productsv2.png" title="sample_states_productsv2.png" width="1770" height="884"></figure><p id="ktu7m0_79">Для состояния соответствующему фактическому физическому удалению необходимо предусмотреть соответствующее значение, например <span class="control" id="ktu7m0_80">-1</span> - это физическое удаление.</p><section class="chapter"><h3 id="ktu7m0_81" data-toc="ktu7m0_81">Пример работы с таблицей состояний</h3><p id="ktu7m0_82">Создание таблиц и заполнение данными</p><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.states">
create table public.states
(
    id         integer generated by default as identity
        constraint states_pk
            primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';
comment on column public.states.state_name is 'Наименование состояния';
comment on column public.states.state_memo is 'Описание';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2">
create table public.productsv2
(
    id           integer generated by default as identity
        constraint productsv2_pk
            primary key,
    state        integer                                            not null
        constraint productsv2_states_id_fk
            references public.states,
    product_name text                                               not null,
    created_at   timestamp with time zone default CURRENT_TIMESTAMP not null,
    updated_at   timestamp with time zone
);

comment on column public.productsv2.id is 'Идентификатор';
comment on column public.productsv2.state is 'Идентификатор состояния';
comment on column public.productsv2.product_name is 'Наименование';
comment on column public.productsv2.created_at is 'Дата создания';
comment on column public.productsv2.updated_at is 'Дата обновления';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2_states">
create table public.productsv2_states
(
    id         integer generated by default as identity
        constraint pk_productsv2_states_id
            primary key,
    product_id integer                                            not null,
    logdate    timestamp with time zone default CURRENT_TIMESTAMP not null,
    state      integer                                            not null
        constraint fk_productsv2_states_states
            references public.states
);

comment on table public.productsv2_states is 'История состояний для товаров';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="insert into public.states (id, state_name, state_memo)">
insert into public.states (id, state_name, state_memo)
values  (1, 'Неактивно', null),
        (2, 'Активно', null),
        (3, 'Требуется коректировка', null),
        (103, 'Требуется коректировка', 'Логическое удаление'),
        (102, 'Активно', 'Логическое удаление'),
        (-1, 'Удалено', 'Физическое удаление'),
        (101, 'Неактивно', 'Логическое удаление');
</div><p id="ktu7m0_87">Создание новых данных</p><div class="code-block" data-lang="sql">
-- Очистка данных
delete from public.productsv2;
delete from public.productsv2_states;

-- создание новых данных
begin;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with inserted as(
insert into public.productsv2(id, state, product_name)
values  (1, 1, 'Товар1'),
        (2, 1, 'Товар2'),
        (3, 3, 'Товар3 с незаполненными даными'),
        (4, 2, 'Товар4'),
        (5, 2, 'Товар5')
returning id, state, created_at)
insert into _tmpdataStates(id, state, logdate) select id, state, created_at from inserted;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;

commit;
</div><p id="ktu7m0_89">Обновление данных</p><div class="code-block" data-lang="sql">
-- Обновление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = 2,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="ktu7m0_91">Логическое удаление данных</p><div class="code-block" data-lang="sql">
-- логическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = case when state&lt;100 then state+100 else state end,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="ktu7m0_93">Физическое удаление</p><div class="code-block" data-lang="sql">
-- физическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    delete from public.productsv2 where id=1
returning id)
insert into _tmpdataStates(id, state, logdate) select id, -1, CURRENT_TIMESTAMP from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="ktu7m0_95">Просмотр истории состояния</p><div class="code-block" data-lang="sql">
select p.*, p2s.logdate as log_date, p2s.state as log_state
from public.productsv2 p left join public.productsv2_states p2s on p.id = p2s.product_id
order by p.id, logdate desc;

select * from productsv2_states st where state=-1;
</div></section></section><div class="last-modified">Last modified: 08 июня 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="database-desing-updateby.html" class="navigation-links__prev">Применение столбцов updated_by и created_by</a><a href="database-desing-updateby-external.html" class="navigation-links__next">Данные о действиях в отдельной таблице</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="frontend/app.js"></script></body></html>