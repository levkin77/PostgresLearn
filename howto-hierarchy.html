<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-04-17T06:07:31.5951364"><title>Иерархические запросы | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"-ceen5p_194","level":0,"title":"Создание таблицы с древовидной структурой","anchor":"#-ceen5p_194"},{"id":"-ceen5p_200","level":0,"title":"Рекурсивный запрос","anchor":"#-ceen5p_200"},{"id":"extention-tablefunc","level":0,"title":"Использование extention tablefunc","anchor":"#extention-tablefunc"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.css" rel="stylesheet"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Иерархические запросы | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/howto-hierarchy.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Иерархические запросы | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/howto-hierarchy.html#webpage",
    "url": "writerside-documentation/howto-hierarchy.html",
    "name": "Иерархические запросы | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="howto-hierarchy" data-main-title="Иерархические запросы" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Default-topic.md|Postgres - полезные ресурсы, руководства подсказки, советы///How-to.md|Советы///howto-customgeneric.md|Общее"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="howto-hierarchy" id="howto-hierarchy.md">Иерархические запросы</h1><section class="chapter"><h2 id="-ceen5p_194" data-toc="-ceen5p_194">Создание таблицы с древовидной структурой</h2><p id="-ceen5p_195">Для начала создадим таблицу и заполним ее тестовыми данными. Как видно наше дерево построено с использованием полей <span class="control" id="-ceen5p_196">manager_no</span> и <span class="control" id="-ceen5p_197">emp_no</span></p><div class="code-block" data-lang="sql">
create table dummy_table
(
    emp_no     int,
    ename      char(5),
    job        char(9),
    manager_no int
);
</div><div class="code-block" data-lang="sql">
insert into dummy_table values(10,'A1','CEO',null);
insert into dummy_table values(11, 'B1', 'VP', 10);
insert into dummy_table values(12, 'B2', 'VP', 10);
insert into dummy_table values(13, 'B3', 'VP', 10);
insert into dummy_table values(14, 'C1', 'DIRECTOR', 13);
insert into dummy_table values(15, 'C2', 'DIRECTOR', 13);
insert into dummy_table values(16, 'D1', 'MANAGER', 15);
insert into dummy_table values(17 ,'E1', 'ENGINEER', 11);
insert into dummy_table values(18, 'E2', 'ENGINEER', 11);
</div></section><section class="chapter"><h2 id="-ceen5p_200" data-toc="-ceen5p_200">Рекурсивный запрос</h2><div class="code-block" data-lang="sql">
with recursive cte as
    (select emp_no, ename, manager_no, 1 as level
                       from dummy_table
                       where manager_no is null
                       union all
                       select e.emp_no, e.ename, e.manager_no, c.level + 1
                       from cte c
                                join dummy_table e on e.manager_no = c.emp_no)
select *
from cte;
</div><p id="-ceen5p_202">Результат:</p><div class="table-wrapper"><table class="wide" id="-ceen5p_203"><thead><tr class="ijRowHead" id="-ceen5p_204"><th id="-ceen5p_205"><p>emp_no</p></th><th id="-ceen5p_206"><p>ename</p></th><th id="-ceen5p_207"><p>manager_no</p></th><th id="-ceen5p_208"><p>level</p></th></tr></thead><tbody><tr id="-ceen5p_209"><td id="-ceen5p_210"><p>10</p></td><td id="-ceen5p_211"><p>A1</p></td><td id="-ceen5p_212"><p>null</p></td><td id="-ceen5p_213"><p>1</p></td></tr><tr id="-ceen5p_214"><td id="-ceen5p_215"><p>11</p></td><td id="-ceen5p_216"><p>B1</p></td><td id="-ceen5p_217"><p>10</p></td><td id="-ceen5p_218"><p>2</p></td></tr><tr id="-ceen5p_219"><td id="-ceen5p_220"><p>12</p></td><td id="-ceen5p_221"><p>B2</p></td><td id="-ceen5p_222"><p>10</p></td><td id="-ceen5p_223"><p>2</p></td></tr><tr id="-ceen5p_224"><td id="-ceen5p_225"><p>13</p></td><td id="-ceen5p_226"><p>B3</p></td><td id="-ceen5p_227"><p>10</p></td><td id="-ceen5p_228"><p>2</p></td></tr><tr id="-ceen5p_229"><td id="-ceen5p_230"><p>14</p></td><td id="-ceen5p_231"><p>C1</p></td><td id="-ceen5p_232"><p>13</p></td><td id="-ceen5p_233"><p>3</p></td></tr><tr id="-ceen5p_234"><td id="-ceen5p_235"><p>15</p></td><td id="-ceen5p_236"><p>C2</p></td><td id="-ceen5p_237"><p>13</p></td><td id="-ceen5p_238"><p>3</p></td></tr><tr id="-ceen5p_239"><td id="-ceen5p_240"><p>17</p></td><td id="-ceen5p_241"><p>E1</p></td><td id="-ceen5p_242"><p>11</p></td><td id="-ceen5p_243"><p>3</p></td></tr><tr id="-ceen5p_244"><td id="-ceen5p_245"><p>18</p></td><td id="-ceen5p_246"><p>E2</p></td><td id="-ceen5p_247"><p>11</p></td><td id="-ceen5p_248"><p>3</p></td></tr><tr id="-ceen5p_249"><td id="-ceen5p_250"><p>16</p></td><td id="-ceen5p_251"><p>D1</p></td><td id="-ceen5p_252"><p>15</p></td><td id="-ceen5p_253"><p>4</p></td></tr></tbody></table></div></section><section class="chapter"><h2 id="extention-tablefunc" data-toc="extention-tablefunc">Использование extention tablefunc</h2><p id="-ceen5p_254">Создаем дополнительное расширение tablefunc.</p><div class="code-block" data-lang="sql">
create extension tablefunc;
</div><p id="-ceen5p_256">Интересующая нас функция</p><div class="code-block" data-lang="sql">
connectby(text relname, text keyid_fld, text parent_keyid_fld [, text orderby_fld ], text start_with, int max_depth [, text branch_delim ])
</div><p id="-ceen5p_258">Праматры функции:</p><ul class="list _bullet" id="-ceen5p_259"><li class="list__item" id="-ceen5p_260"><p>relname: наименование исходной таблицы</p></li><li class="list__item" id="-ceen5p_261"><p>keyid_fld: наименование ключевого поля</p></li><li class="list__item" id="-ceen5p_262"><p>parent_keyid_fld: наименование parent-key поля</p></li><li class="list__item" id="-ceen5p_263"><p>orderby_fld: наименование поля для сортировки (опционально)</p></li><li class="list__item" id="-ceen5p_264"><p>start_with: значение с которого необходимо начать выполнение запроса</p></li><li class="list__item" id="-ceen5p_265"><p>max_depth: максимальная глубина или 0 для максимальной глубины</p></li><li class="list__item" id="-ceen5p_266"><p>branch_delim: строка-разделитель для ключей (опционально)</p></li></ul><p id="-ceen5p_267">Выполняем запрос</p><div class="code-block" data-lang="sql">
select *
from connectby('dummy_table', 'emp_no', 'manager_no', '10', 0, '-&gt;') as t(emp_no int, manager_no int, level int, ord text)
order by emp_no;
</div><p id="-ceen5p_269">Результат</p><div class="table-wrapper"><table class="wide" id="-ceen5p_270"><thead><tr class="ijRowHead" id="-ceen5p_271"><th id="-ceen5p_272"><p>emp_no</p></th><th id="-ceen5p_273"><p>manager_no</p></th><th id="-ceen5p_274"><p>level</p></th><th id="-ceen5p_275"><p>ord</p></th></tr></thead><tbody><tr id="-ceen5p_276"><td id="-ceen5p_277"><p>10</p></td><td id="-ceen5p_278"><p>null</p></td><td id="-ceen5p_279"><p>0</p></td><td id="-ceen5p_280"><p>10</p></td></tr><tr id="-ceen5p_281"><td id="-ceen5p_282"><p>11</p></td><td id="-ceen5p_283"><p>10</p></td><td id="-ceen5p_284"><p>1</p></td><td id="-ceen5p_285"><p>10-&gt;11</p></td></tr><tr id="-ceen5p_286"><td id="-ceen5p_287"><p>12</p></td><td id="-ceen5p_288"><p>10</p></td><td id="-ceen5p_289"><p>1</p></td><td id="-ceen5p_290"><p>10-&gt;12</p></td></tr><tr id="-ceen5p_291"><td id="-ceen5p_292"><p>13</p></td><td id="-ceen5p_293"><p>10</p></td><td id="-ceen5p_294"><p>1</p></td><td id="-ceen5p_295"><p>10-&gt;13</p></td></tr><tr id="-ceen5p_296"><td id="-ceen5p_297"><p>14</p></td><td id="-ceen5p_298"><p>13</p></td><td id="-ceen5p_299"><p>2</p></td><td id="-ceen5p_300"><p>10-&gt;13-&gt;14</p></td></tr><tr id="-ceen5p_301"><td id="-ceen5p_302"><p>15</p></td><td id="-ceen5p_303"><p>13</p></td><td id="-ceen5p_304"><p>2</p></td><td id="-ceen5p_305"><p>10-&gt;13-&gt;15</p></td></tr><tr id="-ceen5p_306"><td id="-ceen5p_307"><p>16</p></td><td id="-ceen5p_308"><p>15</p></td><td id="-ceen5p_309"><p>3</p></td><td id="-ceen5p_310"><p>10-&gt;13-&gt;15-&gt;16</p></td></tr><tr id="-ceen5p_311"><td id="-ceen5p_312"><p>17</p></td><td id="-ceen5p_313"><p>11</p></td><td id="-ceen5p_314"><p>2</p></td><td id="-ceen5p_315"><p>10-&gt;11-&gt;17</p></td></tr><tr id="-ceen5p_316"><td id="-ceen5p_317"><p>18</p></td><td id="-ceen5p_318"><p>11</p></td><td id="-ceen5p_319"><p>2</p></td><td id="-ceen5p_320"><p>10-&gt;11-&gt;18</p></td></tr></tbody></table></div><p id="-ceen5p_321">Вариант запроса</p><div class="code-block" data-lang="sql">
select *
from connectby('dummy_table', 'emp_no', 'manager_no', 'emp_no', '10', 0,
               '-&gt;') as t(emp_no int, manager_no int, level int, branch text, ord int);
</div><p id="-ceen5p_323">Результат</p><div class="table-wrapper"><table class="wide" id="-ceen5p_324"><thead><tr class="ijRowHead" id="-ceen5p_325"><th id="-ceen5p_326"><p>emp_no</p></th><th id="-ceen5p_327"><p>manager_no</p></th><th id="-ceen5p_328"><p>level</p></th><th id="-ceen5p_329"><p>branch</p></th><th id="-ceen5p_330"><p>ord</p></th></tr></thead><tbody><tr id="-ceen5p_331"><td id="-ceen5p_332"><p>10</p></td><td id="-ceen5p_333"><p>null</p></td><td id="-ceen5p_334"><p>0</p></td><td id="-ceen5p_335"><p>10</p></td><td id="-ceen5p_336"><p>1</p></td></tr><tr id="-ceen5p_337"><td id="-ceen5p_338"><p>11</p></td><td id="-ceen5p_339"><p>10</p></td><td id="-ceen5p_340"><p>1</p></td><td id="-ceen5p_341"><p>10-&gt;11</p></td><td id="-ceen5p_342"><p>2</p></td></tr><tr id="-ceen5p_343"><td id="-ceen5p_344"><p>17</p></td><td id="-ceen5p_345"><p>11</p></td><td id="-ceen5p_346"><p>2</p></td><td id="-ceen5p_347"><p>10-&gt;11-&gt;17</p></td><td id="-ceen5p_348"><p>3</p></td></tr><tr id="-ceen5p_349"><td id="-ceen5p_350"><p>18</p></td><td id="-ceen5p_351"><p>11</p></td><td id="-ceen5p_352"><p>2</p></td><td id="-ceen5p_353"><p>10-&gt;11-&gt;18</p></td><td id="-ceen5p_354"><p>4</p></td></tr><tr id="-ceen5p_355"><td id="-ceen5p_356"><p>12</p></td><td id="-ceen5p_357"><p>10</p></td><td id="-ceen5p_358"><p>1</p></td><td id="-ceen5p_359"><p>10-&gt;12</p></td><td id="-ceen5p_360"><p>5</p></td></tr><tr id="-ceen5p_361"><td id="-ceen5p_362"><p>13</p></td><td id="-ceen5p_363"><p>10</p></td><td id="-ceen5p_364"><p>1</p></td><td id="-ceen5p_365"><p>10-&gt;13</p></td><td id="-ceen5p_366"><p>6</p></td></tr><tr id="-ceen5p_367"><td id="-ceen5p_368"><p>14</p></td><td id="-ceen5p_369"><p>13</p></td><td id="-ceen5p_370"><p>2</p></td><td id="-ceen5p_371"><p>10-&gt;13-&gt;14</p></td><td id="-ceen5p_372"><p>7</p></td></tr><tr id="-ceen5p_373"><td id="-ceen5p_374"><p>15</p></td><td id="-ceen5p_375"><p>13</p></td><td id="-ceen5p_376"><p>2</p></td><td id="-ceen5p_377"><p>10-&gt;13-&gt;15</p></td><td id="-ceen5p_378"><p>8</p></td></tr><tr id="-ceen5p_379"><td id="-ceen5p_380"><p>16</p></td><td id="-ceen5p_381"><p>15</p></td><td id="-ceen5p_382"><p>3</p></td><td id="-ceen5p_383"><p>10-&gt;13-&gt;15-&gt;16</p></td><td id="-ceen5p_384"><p>9</p></td></tr></tbody></table></div></section><div class="last-modified">Last modified: 17 апреля 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="howto-codeblock.html" class="navigation-links__prev">Анонимные блоки кода</a><a href="howto-extentioncustomschema.html" class="navigation-links__next">Установка extention в отдельную схему</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.js"></script></body></html>