<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-04-17T06:07:31.6581346"><title>Логическое удаление | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"deleted-by","level":0,"title":"Использование дополнения deleted_by","anchor":"#deleted-by"},{"id":"cy8rpx_340","level":0,"title":"Использование дополнительной таблицы для истории состояния","anchor":"#cy8rpx_340"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.css" rel="stylesheet"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Логическое удаление | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/database-desing-deleteby-md.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Логическое удаление | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/database-desing-deleteby-md.html#webpage",
    "url": "writerside-documentation/database-desing-deleteby-md.html",
    "name": "Логическое удаление | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="database-desing-deleteby-md" data-main-title="Логическое удаление" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Default-topic.md|Postgres - полезные ресурсы, руководства подсказки, советы///database-desing.md|Проектирование баз данных"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="database-desing-deleteby-md" id="database-desing-deleteby-md.md">Логическое удаление</h1><p id="cy8rpx_292">Принцип логического удаления данные применяют достаточно часто. В большинстве случаев для этого применяют не просто логический флаг для записи &quot;удалена/активна&quot;, а в более расширенном виде таблицы текущих состояний и соответствующего столбца <span class="control" id="cy8rpx_293">StateId</span> в основной таблице.</p><figure id="cy8rpx_294"><img alt="sample_states_products.png" src="images/sample_states_products.png" title="sample_states_products.png" width="733" height="674"></figure><div class="code-block" data-lang="sql">
create table public.states
(
    id integer generated by default as identity
        constraint states_pk primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';

comment on column public.states.state_name is 'Наименование';

comment on column public.states.state_memo is 'Описание';
</div><p id="cy8rpx_296">Пример возможных значений:</p><div class="table-wrapper"><table class="wide" id="cy8rpx_297"><thead><tr class="ijRowHead" id="cy8rpx_298"><th id="cy8rpx_299"><p>id</p></th><th id="cy8rpx_300"><p>state_name</p></th><th id="cy8rpx_301"><p>state_memo</p></th></tr></thead><tbody><tr id="cy8rpx_302"><td id="cy8rpx_303"><p>1</p></td><td id="cy8rpx_304"><p>Неактивно</p></td><td id="cy8rpx_305"><p>null</p></td></tr><tr id="cy8rpx_306"><td id="cy8rpx_307"><p>2</p></td><td id="cy8rpx_308"><p>Активно</p></td><td id="cy8rpx_309"><p>null</p></td></tr><tr id="cy8rpx_310"><td id="cy8rpx_311"><p>3</p></td><td id="cy8rpx_312"><p>Требуется коректировка</p></td><td id="cy8rpx_313"><p>null</p></td></tr></tbody></table></div><p id="cy8rpx_314">Для удаленных состояний можно применять как собственное значение, например:</p><ul class="list _bullet" id="cy8rpx_315"><li class="list__item" id="cy8rpx_316"><p><span class="control" id="cy8rpx_317">-1</span> - соответствует значению удалена</p></li><li class="list__item" id="cy8rpx_318"><p>как &quot;текущее состояние + 100&quot;,т.е. 101 - соответствует &quot;была неактивна и удалена&quot;, 102 - &quot;была активна и удалена&quot;</p></li></ul><section class="chapter"><h2 id="deleted-by" data-toc="deleted-by">Использование дополнения deleted_by</h2><p id="cy8rpx_319">В некоторых случаях будет полезным использовать в таблице соответствующих столбцов для ведения дополнительной аналитики:</p><ul class="list _bullet" id="cy8rpx_320"><li class="list__item" id="cy8rpx_321"><p><span class="control" id="cy8rpx_322">deleted_by</span> - ссылка на пользователя/или текст, кем удалена</p></li><li class="list__item" id="cy8rpx_323"><p><span class="control" id="cy8rpx_324">deleted_on</span> или <span class="control" id="cy8rpx_325">deleted_at</span> - дата/время, когда удалена</p></li></ul><p id="cy8rpx_326">Данные столбцы полезны только при отсутствии в таблице столбцов отвечающих за состояние <span class="control" id="cy8rpx_327">StateId</span>, <span class="control" id="cy8rpx_328">updated_at</span>, так как данные столбцы полностью покрывают информацию столбца deleted_on</p><aside class="prompt" data-type="tip" data-title="" id="cy8rpx_329"><p id="cy8rpx_330">При использовании столбцов <span class="control" id="cy8rpx_331">deleted_on</span> и <span class="control" id="cy8rpx_332">StateId</span> желательно предусмотреть правильное ограничение, учитывающее, что при наличии данных в столбце <span class="control" id="cy8rpx_333">deleted_on</span> значения в столбце <span class="control" id="cy8rpx_334">StateId</span> должно соответствовать только &quot;удаленным&quot; состояниям.</p></aside><aside class="prompt" data-type="tip" data-title="" id="cy8rpx_335"><p id="cy8rpx_336">Столбец <span class="control" id="cy8rpx_337">deleted_on</span> такжн может оказаться очень полезным для ETL процессов, например для исключения необходимости обновления данных для уже удаленных строк</p></aside><aside class="prompt" data-type="tip" data-title="" id="cy8rpx_338"><p id="cy8rpx_339">Реализация &quot;состояний&quot; - не всегда является простой задачей и может представлять достаточно сложную в реализации при необходимости реализации &quot;состояния с учетом времени&quot;.</p></aside></section><section class="chapter"><h2 id="cy8rpx_340" data-toc="cy8rpx_340">Использование дополнительной таблицы для истории состояния</h2><p id="cy8rpx_341">Для более правильного подхода к реализации &quot;состояния записи&quot; и логического удаления можно использовать дополнительную таблицу &quot;История состояния&quot;.</p><p id="cy8rpx_342">Принцип данного подхода - наличие необходимых (нужных вам) столбцов в основной таблице</p><ul class="list _bullet" id="cy8rpx_343"><li class="list__item" id="cy8rpx_344"><p><span class="control" id="cy8rpx_345">StateId</span> - текущее состояние</p></li><li class="list__item" id="cy8rpx_346"><p><span class="control" id="cy8rpx_347">create_at</span> - дата создания</p></li><li class="list__item" id="cy8rpx_348"><p><span class="control" id="cy8rpx_349">update_at</span> - дата обновления</p></li><li class="list__item" id="cy8rpx_350"><p><span class="control" id="cy8rpx_351">created_by</span> - кем создана</p></li><li class="list__item" id="cy8rpx_352"><p><span class="control" id="cy8rpx_353">updated_by</span> - кем обновлена</p></li></ul><p id="cy8rpx_354">И наличие дополнительной таблицы со столбцами</p><ul class="list _bullet" id="cy8rpx_355"><li class="list__item" id="cy8rpx_356"><p><span class="control" id="cy8rpx_357">pk</span> - идентификатор записи</p></li><li class="list__item" id="cy8rpx_358"><p><span class="control" id="cy8rpx_359">source_id</span> - ссылка на ключ исходной таблицы</p></li><li class="list__item" id="cy8rpx_360"><p><span class="control" id="cy8rpx_361">logdate</span> - фактическая дата протоколирования, которое будет соответствовать значениям столбцов <span class="control" id="cy8rpx_362">create_at</span>, <span class="control" id="cy8rpx_363">update_at</span></p></li><li class="list__item" id="cy8rpx_364"><p><span class="control" id="cy8rpx_365">stateId</span> - идентификатор состояния</p></li><li class="list__item" id="cy8rpx_366"><p><span class="control" id="cy8rpx_367">uid_key</span> - пользователь, кем выполнено действие</p></li></ul><figure id="cy8rpx_368"><img alt="sample_states_productsv2.png" src="images/sample_states_productsv2.png" title="sample_states_productsv2.png" width="1770" height="884"></figure><p id="cy8rpx_369">Для состояния соответствующему фактическому физическому удалению необходимо предусмотреть соответствующее значение, например <span class="control" id="cy8rpx_370">-1</span> - это физическое удаление.</p><section class="chapter"><h3 id="cy8rpx_371" data-toc="cy8rpx_371">Пример работы с таблицей состояний</h3><p id="cy8rpx_372">Создание таблиц и заполнение данными</p><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.states">
create table public.states
(
    id         integer generated by default as identity
        constraint states_pk
            primary key,
    state_name text not null,
    state_memo text
);

comment on column public.states.id is 'Ключ';
comment on column public.states.state_name is 'Наименование состояния';
comment on column public.states.state_memo is 'Описание';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2">
create table public.productsv2
(
    id           integer generated by default as identity
        constraint productsv2_pk
            primary key,
    state        integer                                            not null
        constraint productsv2_states_id_fk
            references public.states,
    product_name text                                               not null,
    created_at   timestamp with time zone default CURRENT_TIMESTAMP not null,
    updated_at   timestamp with time zone
);

comment on column public.productsv2.id is 'Идентификатор';
comment on column public.productsv2.state is 'Идентификатор состояния';
comment on column public.productsv2.product_name is 'Наименование';
comment on column public.productsv2.created_at is 'Дата создания';
comment on column public.productsv2.updated_at is 'Дата обновления';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productsv2_states">
create table public.productsv2_states
(
    id         integer generated by default as identity
        constraint pk_productsv2_states_id
            primary key,
    product_id integer                                            not null,
    logdate    timestamp with time zone default CURRENT_TIMESTAMP not null,
    state      integer                                            not null
        constraint fk_productsv2_states_states
            references public.states
);

comment on table public.productsv2_states is 'История состояний для товаров';
</div><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="insert into public.states (id, state_name, state_memo)">
insert into public.states (id, state_name, state_memo)
values  (1, 'Неактивно', null),
        (2, 'Активно', null),
        (3, 'Требуется коректировка', null),
        (103, 'Требуется коректировка', 'Логическое удаление'),
        (102, 'Активно', 'Логическое удаление'),
        (-1, 'Удалено', 'Физическое удаление'),
        (101, 'Неактивно', 'Логическое удаление');
</div><p id="cy8rpx_377">Создание новых данных</p><div class="code-block" data-lang="sql">
-- Очистка данных
delete from public.productsv2;
delete from public.productsv2_states;

-- создание новых данных
begin;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with inserted as(
insert into public.productsv2(id, state, product_name)
values  (1, 1, 'Товар1'),
        (2, 1, 'Товар2'),
        (3, 3, 'Товар3 с незаполненными даными'),
        (4, 2, 'Товар4'),
        (5, 2, 'Товар5')
returning id, state, created_at)
insert into _tmpdataStates(id, state, logdate) select id, state, created_at from inserted;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;

commit;
</div><p id="cy8rpx_379">Обновление данных</p><div class="code-block" data-lang="sql">
-- Обновление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = 2,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="cy8rpx_381">Логическое удаление данных</p><div class="code-block" data-lang="sql">
-- логическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    update public.productsv2 set
        product_name=product_name,
        state = case when state&lt;100 then state+100 else state end,
        updated_at = CURRENT_TIMESTAMP
        where id=1
returning id, state, updated_at)
insert into _tmpdataStates(id, state, logdate) select id, state, updated_at from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="cy8rpx_383">Физическое удаление</p><div class="code-block" data-lang="sql">
-- физическое удаление данных
begin transaction;
drop table if exists _tmpdataStates;
create temp table _tmpdataStates(id int, state int, logdate timestamptz) on commit drop;
with updatedValues as(
    delete from public.productsv2 where id=1
returning id)
insert into _tmpdataStates(id, state, logdate) select id, -1, CURRENT_TIMESTAMP from updatedValues;

insert into public.productsv2_states(product_id, state, logdate)
select t.id, t.state, t.logdate from _tmpdataStates t;
commit transaction ;
-------------
</div><p id="cy8rpx_385">Просмотр истории состояния</p><div class="code-block" data-lang="sql">
select p.*, p2s.logdate as log_date, p2s.state as log_state
from public.productsv2 p left join public.productsv2_states p2s on p.id = p2s.product_id
order by p.id, logdate desc;

select * from productsv2_states st where state=-1;
</div></section></section><div class="last-modified">Last modified: 17 апреля 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="database-desing-updateby.html" class="navigation-links__prev">Применение столбцов updated_by и created_by</a><a href="database-desing-updateby-external.html" class="navigation-links__next">Данные о действиях в отдельной таблице</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.js"></script></body></html>