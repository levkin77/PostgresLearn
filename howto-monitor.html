<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-03-31T12:38:30.6551264"><title>Мониторинг запросов | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"pg-stat-statements","level":0,"title":"Установка pg_stat_statements","anchor":"#pg-stat-statements"},{"id":"-8a1v5u_836","level":0,"title":"Мониторинг запросов","anchor":"#-8a1v5u_836"},{"id":"-8a1v5u_842","level":0,"title":"Размеры нашей статистики запросов","anchor":"#-8a1v5u_842"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.css" rel="stylesheet"><link rel="manifest" href="site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Мониторинг запросов | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/howto-monitor.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Мониторинг запросов | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/howto-monitor.html#webpage",
    "url": "writerside-documentation/howto-monitor.html",
    "name": "Мониторинг запросов | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="howto-monitor" data-main-title="Мониторинг запросов" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="pjstgres-resourcesl.md|Ресурсы///How-to.md|Советы"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="howto-monitor" id="howto-monitor.md">Мониторинг запросов</h1><div class="code-block" data-lang="sql">
create extension pg_stat_statements;
</div><section class="chapter"><h2 id="pg-stat-statements" data-toc="pg-stat-statements">Установка pg_stat_statements</h2><p id="-8a1v5u_684">Сначала проверяем</p><div class="code-block" data-lang="sql">
select * from pg_settings where name = 'shared_preload_libraries';
show shared_preload_libraries;
</div><p id="-8a1v5u_686">При необходимости добавляем расширение в postgresql.conf</p><div class="code-block" data-lang="plaintext">
shared_preload_libraries = 'pg_stat_statements'	# (change requires restart)
pg_stat_statements.max=20000
pg_stat_statements.track= top
</div><ul class="list _bullet" id="-8a1v5u_688"><li class="list__item" id="-8a1v5u_689"><p><span class="emphasis" id="-8a1v5u_690">pg_stat_statements.max</span> &ndash; sets the max number of statements PostgreSQL will keep track of. The Default is 5000.</p></li><li class="list__item" id="-8a1v5u_691"><p><span class="emphasis" id="-8a1v5u_692">pg_stat_statements.track</span> &ndash; По умолчанию top. </p><ul class="list _bullet" id="-8a1v5u_693"><li class="list__item" id="-8a1v5u_694"><p>all &ndash; все, включая содержимое функций</p></li><li class="list__item" id="-8a1v5u_695"><p>top &ndash; только клиенткие</p></li><li class="list__item" id="-8a1v5u_696"><p>none &ndash; отключить</p></li></ul></li></ul><aside class="prompt" data-type="warning" data-title="" id="-8a1v5u_697"><p id="-8a1v5u_698">После установки расширения в <span class="emphasis" id="-8a1v5u_699">shared_preload_libraries</span> требуется рестарт сервера!</p></aside><p id="-8a1v5u_700">Посмотреть структуру представления в psql:</p><div class="code-block" data-lang="sql">
\d pg_stat_statements
</div><p id="-8a1v5u_702">Представление &quot;public.pg_stat_statements&quot;</p><div class="table-wrapper"><table class="wide" id="-8a1v5u_703"><thead><tr class="ijRowHead" id="-8a1v5u_704"><th id="-8a1v5u_705"><p>Столбец</p></th><th id="-8a1v5u_706"><p>Тип</p></th></tr></thead><tbody><tr id="-8a1v5u_707"><td id="-8a1v5u_708"><p>userid</p></td><td id="-8a1v5u_709"><p>oid</p></td></tr><tr id="-8a1v5u_710"><td id="-8a1v5u_711"><p>dbid</p></td><td id="-8a1v5u_712"><p>oid</p></td></tr><tr id="-8a1v5u_713"><td id="-8a1v5u_714"><p>toplevel</p></td><td id="-8a1v5u_715"><p>boolean</p></td></tr><tr id="-8a1v5u_716"><td id="-8a1v5u_717"><p>queryid</p></td><td id="-8a1v5u_718"><p>bigint</p></td></tr><tr id="-8a1v5u_719"><td id="-8a1v5u_720"><p>query</p></td><td id="-8a1v5u_721"><p>text</p></td></tr><tr id="-8a1v5u_722"><td id="-8a1v5u_723"><p>plans</p></td><td id="-8a1v5u_724"><p>bigint</p></td></tr><tr id="-8a1v5u_725"><td id="-8a1v5u_726"><p>total_plan_time</p></td><td id="-8a1v5u_727"><p>double precision</p></td></tr><tr id="-8a1v5u_728"><td id="-8a1v5u_729"><p>min_plan_time</p></td><td id="-8a1v5u_730"><p>double precision</p></td></tr><tr id="-8a1v5u_731"><td id="-8a1v5u_732"><p>max_plan_time</p></td><td id="-8a1v5u_733"><p>double precision</p></td></tr><tr id="-8a1v5u_734"><td id="-8a1v5u_735"><p>mean_plan_time</p></td><td id="-8a1v5u_736"><p>double precision</p></td></tr><tr id="-8a1v5u_737"><td id="-8a1v5u_738"><p>stddev_plan_time</p></td><td id="-8a1v5u_739"><p>double precision</p></td></tr><tr id="-8a1v5u_740"><td id="-8a1v5u_741"><p>calls</p></td><td id="-8a1v5u_742"><p>bigint</p></td></tr><tr id="-8a1v5u_743"><td id="-8a1v5u_744"><p>total_exec_time</p></td><td id="-8a1v5u_745"><p>double precision</p></td></tr><tr id="-8a1v5u_746"><td id="-8a1v5u_747"><p>min_exec_time</p></td><td id="-8a1v5u_748"><p>double precision</p></td></tr><tr id="-8a1v5u_749"><td id="-8a1v5u_750"><p>max_exec_time</p></td><td id="-8a1v5u_751"><p>double precision</p></td></tr><tr id="-8a1v5u_752"><td id="-8a1v5u_753"><p>mean_exec_time</p></td><td id="-8a1v5u_754"><p>double precision</p></td></tr><tr id="-8a1v5u_755"><td id="-8a1v5u_756"><p>stddev_exec_time</p></td><td id="-8a1v5u_757"><p>double precision</p></td></tr><tr id="-8a1v5u_758"><td id="-8a1v5u_759"><p>rows</p></td><td id="-8a1v5u_760"><p>bigint</p></td></tr><tr id="-8a1v5u_761"><td id="-8a1v5u_762"><p>shared_blks_hit</p></td><td id="-8a1v5u_763"><p>bigint</p></td></tr><tr id="-8a1v5u_764"><td id="-8a1v5u_765"><p>shared_blks_read</p></td><td id="-8a1v5u_766"><p>bigint</p></td></tr><tr id="-8a1v5u_767"><td id="-8a1v5u_768"><p>shared_blks_dirtied</p></td><td id="-8a1v5u_769"><p>bigint</p></td></tr><tr id="-8a1v5u_770"><td id="-8a1v5u_771"><p>shared_blks_written</p></td><td id="-8a1v5u_772"><p>bigint</p></td></tr><tr id="-8a1v5u_773"><td id="-8a1v5u_774"><p>local_blks_hit</p></td><td id="-8a1v5u_775"><p>bigint</p></td></tr><tr id="-8a1v5u_776"><td id="-8a1v5u_777"><p>local_blks_read</p></td><td id="-8a1v5u_778"><p>bigint</p></td></tr><tr id="-8a1v5u_779"><td id="-8a1v5u_780"><p>local_blks_dirtied</p></td><td id="-8a1v5u_781"><p>bigint</p></td></tr><tr id="-8a1v5u_782"><td id="-8a1v5u_783"><p>local_blks_written</p></td><td id="-8a1v5u_784"><p>bigint</p></td></tr><tr id="-8a1v5u_785"><td id="-8a1v5u_786"><p>temp_blks_read</p></td><td id="-8a1v5u_787"><p>bigint</p></td></tr><tr id="-8a1v5u_788"><td id="-8a1v5u_789"><p>temp_blks_written</p></td><td id="-8a1v5u_790"><p>bigint</p></td></tr><tr id="-8a1v5u_791"><td id="-8a1v5u_792"><p>blk_read_time</p></td><td id="-8a1v5u_793"><p>double precision</p></td></tr><tr id="-8a1v5u_794"><td id="-8a1v5u_795"><p>blk_write_time</p></td><td id="-8a1v5u_796"><p>double precision</p></td></tr><tr id="-8a1v5u_797"><td id="-8a1v5u_798"><p>temp_blk_read_time</p></td><td id="-8a1v5u_799"><p>double precision</p></td></tr><tr id="-8a1v5u_800"><td id="-8a1v5u_801"><p>temp_blk_write_time</p></td><td id="-8a1v5u_802"><p>double precision</p></td></tr><tr id="-8a1v5u_803"><td id="-8a1v5u_804"><p>wal_records</p></td><td id="-8a1v5u_805"><p>bigint</p></td></tr><tr id="-8a1v5u_806"><td id="-8a1v5u_807"><p>wal_fpi</p></td><td id="-8a1v5u_808"><p>bigint</p></td></tr><tr id="-8a1v5u_809"><td id="-8a1v5u_810"><p>wal_bytes</p></td><td id="-8a1v5u_811"><p>numeric</p></td></tr><tr id="-8a1v5u_812"><td id="-8a1v5u_813"><p>jit_functions</p></td><td id="-8a1v5u_814"><p>bigint</p></td></tr><tr id="-8a1v5u_815"><td id="-8a1v5u_816"><p>jit_generation_time</p></td><td id="-8a1v5u_817"><p>double precision</p></td></tr><tr id="-8a1v5u_818"><td id="-8a1v5u_819"><p>jit_inlining_count</p></td><td id="-8a1v5u_820"><p>bigint</p></td></tr><tr id="-8a1v5u_821"><td id="-8a1v5u_822"><p>jit_inlining_time</p></td><td id="-8a1v5u_823"><p>double precision</p></td></tr><tr id="-8a1v5u_824"><td id="-8a1v5u_825"><p>jit_optimization_count</p></td><td id="-8a1v5u_826"><p>bigint</p></td></tr><tr id="-8a1v5u_827"><td id="-8a1v5u_828"><p>jit_optimization_time</p></td><td id="-8a1v5u_829"><p>double precision</p></td></tr><tr id="-8a1v5u_830"><td id="-8a1v5u_831"><p>jit_emission_count</p></td><td id="-8a1v5u_832"><p>bigint</p></td></tr><tr id="-8a1v5u_833"><td id="-8a1v5u_834"><p>jit_emission_time</p></td><td id="-8a1v5u_835"><p>double precision</p></td></tr></tbody></table></div></section><section class="chapter"><h2 id="-8a1v5u_836" data-toc="-8a1v5u_836">Мониторинг запросов</h2><div class="code-block" data-lang="sql">
select (total_exec_time / 1000 / 60) as total_min,
       mean_exec_time                as avg_ms,
       calls,
       query
from pg_stat_statements
order by 1 desc
limit 500;
</div><p id="-8a1v5u_838">Топ запросы по времени</p><div class="code-block" data-lang="sql">
select userid::regrole,
       dbid,
       query,
       calls,
       total_exec_time / 1000 as total_time_seconds,
       min_exec_time / 1000   as min_time_seconds,
       max_exec_time / 1000   as max_time_seconds,
       mean_exec_time / 1000  as mean_time_seconds
from pg_stat_statements
order by mean_exec_time desc
limit 10;
</div><p id="-8a1v5u_840">Топ io</p><div class="code-block" data-lang="sql">
select userid::regrole, dbid, query,queryid,mean_exec_time/1000 as mean_time_seconds
    from pg_stat_statements
    order by (blk_read_time+blk_write_time) desc
    limit 10;
</div></section><section class="chapter"><h2 id="-8a1v5u_842" data-toc="-8a1v5u_842">Размеры нашей статистики запросов</h2><div class="code-block" data-lang="sql">
select count(*) from pg_stat_statements;
</div><p id="-8a1v5u_844">в разрезе баз</p><div class="code-block" data-lang="sql">
select pg_stat_statements.dbid,datname,count(*) from pg_stat_statements join
pg_database on pg_stat_statements.dbid=pg_database.oid  group by  pg_stat_statements.dbid,datname;
</div><p id="-8a1v5u_846">Для очистки</p><div class="code-block" data-lang="sql">
select userid::regrole, dbid, queryid, query
from pg_stat_statements
order by (shared_blks_hit + shared_blks_dirtied) desc
limit 10;

-- Для базы id=15845
select pg_stat_statements_reset(0, 15845, 0);

-- для конкретного запроса idsql=123573657
select pg_stat_statements_reset(0, 0, 123573657);
</div><p id="-8a1v5u_848">что почитать:</p><ul class="list _bullet" id="-8a1v5u_849"><li class="list__item" id="-8a1v5u_850"><p><a href="https://dbaclass.com/article/monitor-sql-queries-in-postgres-using-pg_stat_statements/" id="-8a1v5u_851" data-external="true" rel="noopener noreferrer">https://dbaclass.com/article/monitor-sql-queries-in-postgres-using-pg_stat_statements/</a></p></li></ul></section><div class="last-modified">Last modified: 31 марта 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="howto-maintance.html" class="navigation-links__prev">Обслуживание (MAINTENANCE)</a><a href="howto-dbreadonly.html" class="navigation-links__next">База только для чтения</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b224/app.js"></script></body></html>