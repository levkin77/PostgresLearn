<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2024-05-15T09:21:07.199107"><title>Простая реализация EVA с учетом факта времени | Postgres Полезные русурсы</title><script type="application/json" id="virtual-toc-data">[{"id":"-6ey6g6_567","level":0,"title":"Таблицы","anchor":"#-6ey6g6_567"},{"id":"-6ey6g6_575","level":0,"title":"Скрипты создания таблиц и первоначальное заполнения данными","anchor":"#-6ey6g6_575"},{"id":"-6ey6g6_581","level":0,"title":"Примеры запросов получения данных","anchor":"#-6ey6g6_581"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="frontend/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="icon" type="image/png" sizes="32x32" href="writerside_32.png"><link rel="icon" type="image/png" sizes="64x64" href="writerside_64.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Простая реализация EVA с учетом факта времени | Postgres Полезные русурсы"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Postgres Полезные русурсы Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/db-design-simpleeavfa.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Простая реализация EVA с учетом факта времени | Postgres Полезные русурсы"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/db-design-simpleeavfa.html#webpage",
    "url": "writerside-documentation/db-design-simpleeavfa.html",
    "name": "Простая реализация EVA с учетом факта времени | Postgres Полезные русурсы",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Postgres Полезные русурсы Help"
}</script><!-- End Schema.org --></head><body data-id="db-design-simpleeavfa" data-main-title="Простая реализация EVA с учетом факта времени" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Default-topic.md|Postgres - полезные ресурсы, руководства подсказки, советы///db-design.md|Проектирование баз данных"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Postgres Полезные русурсы  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="db-design-simpleeavfa" id="db-design-simpleeavfa.md">Простая реализация EVA с учетом факта времени</h1><p id="-6ey6g6_563">Данная модель основана на <a href="db-design-simpleeav.html" id="-6ey6g6_564" data-tooltip="Очень простая модель для представления. Принцип модели позволяет решит наиболее распостраненную задачу:">модели простой EVA</a></p><p id="-6ey6g6_565">Данная модель позволяет сделать дополнительный свойства основного объекта зависимыми от времени, что позволяет хранить историю изменения значений дополнительных свойств и соответственно получать необходимый резаультат на нужную дату.</p><figure id="-6ey6g6_566"><img alt="simple_eva2.png" src="images/simple_eva2.png" title="simple_eva2.png" width="1089" height="524"></figure><section class="chapter"><h2 id="-6ey6g6_567" data-toc="-6ey6g6_567">Таблицы</h2><ol class="list _decimal" id="-6ey6g6_568" type="1"><li class="list__item" id="-6ey6g6_569"><p><span class="control" id="-6ey6g6_570">products</span> - товары</p></li><li class="list__item" id="-6ey6g6_571"><p><span class="control" id="-6ey6g6_572">productcodenames</span> - наименования дополнительных свойств (атрибутов)</p></li><li class="list__item" id="-6ey6g6_573"><p><span class="control" id="-6ey6g6_574">productcodes</span> - значения дополнительных свойств (атрибутов)</p></li></ol></section><section class="chapter"><h2 id="-6ey6g6_575" data-toc="-6ey6g6_575">Скрипты создания таблиц и первоначальное заполнения данными</h2><p id="-6ey6g6_576"><a data-external="true" id="-6ey6g6_577" href="resources/postgres16_localhost-devschemaeav2.sql" target="_blank" rel="noopener noreferrer">Скрипт создания таблиц</a></p><p id="-6ey6g6_578">Таблица <span class="control" id="-6ey6g6_579">productcodes</span></p><div class="code-collapse" data-lang="sql" data-is-expanded="false" data-synopsis="create table public.productcodes (">
create table public.productcodes (
  id integer primary key not null, -- Идентификатор
  produc_id integer not null, -- Идентификатор товара
  code_id integer not null, -- Идентификатор дополнительного свойства
  date_actual timestamp(6) with time zone not null default now(), -- Дата актуальности
  vint integer, -- Целое значение
  vtext text, -- Строка
  vdate date, -- Дата
  vnum double precision, -- Дробное
  vmoney numeric(15,6), -- Денежное
  vjson jsonb, -- Json
  memo text, -- Описание
  foreign key (code_id) references public.productcodenames (id)
  match simple on update no action on delete no action,
  foreign key (produc_id) references public.products (id)
  match simple on update no action on delete no action
);
create unique index ix_productcodes_guard on productcodes using btree (produc_id, code_id, date_actual);
comment on table public.productcodes is 'Значения дополнительных кодов';
comment on column public.productcodes.id is 'Идентификатор';
comment on column public.productcodes.produc_id is 'Идентификатор товара';
comment on column public.productcodes.code_id is 'Идентификатор дополнительного свойства';
comment on column public.productcodes.date_actual is 'Дата актуальности';
comment on column public.productcodes.vint is 'Целое значение';
comment on column public.productcodes.vtext is 'Строка';
comment on column public.productcodes.vdate is 'Дата';
comment on column public.productcodes.vnum is 'Дробное';
comment on column public.productcodes.vmoney is 'Денежное';
comment on column public.productcodes.vjson is 'Json';
comment on column public.productcodes.memo is 'Описание';
</div></section><section class="chapter"><h2 id="-6ey6g6_581" data-toc="-6ey6g6_581">Примеры запросов получения данных</h2><section class="chapter"><h3 id="-6ey6g6_582" data-toc="-6ey6g6_582">Данные о истории дополнительного одного дополнительного свойства</h3><div class="code-block" data-lang="sql">
select p.id as product_id, p.name as produc_name,
       pv.code_id, pn.name as pname, pv.date_actual::date, pv.vint
from public.products p
     inner join public.productcodes pv on p.id = pv.produc_id and pv.code_id=1
     inner join public.productcodenames pn on pv.code_id = pn.id
where p.id=1 order by pv.date_actual desc;
</div><p id="-6ey6g6_584">Результат:</p><div class="table-wrapper"><table class="wide" id="-6ey6g6_585"><thead><tr class="ijRowHead" id="-6ey6g6_586"><th id="-6ey6g6_587"><p>product_id</p></th><th id="-6ey6g6_588"><p>produc_name</p></th><th id="-6ey6g6_589"><p>code_id</p></th><th id="-6ey6g6_590"><p>pname</p></th><th id="-6ey6g6_591"><p>date_actual</p></th><th id="-6ey6g6_592"><p>vint</p></th></tr></thead><tbody><tr id="-6ey6g6_593"><td id="-6ey6g6_594"><p>1</p></td><td id="-6ey6g6_595"><p>product 1</p></td><td id="-6ey6g6_596"><p>1</p></td><td id="-6ey6g6_597"><p>int value</p></td><td id="-6ey6g6_598"><p>2024-05-03</p></td><td id="-6ey6g6_599"><p>14</p></td></tr><tr id="-6ey6g6_600"><td id="-6ey6g6_601"><p>1</p></td><td id="-6ey6g6_602"><p>product 1</p></td><td id="-6ey6g6_603"><p>1</p></td><td id="-6ey6g6_604"><p>int value</p></td><td id="-6ey6g6_605"><p>2024-05-02</p></td><td id="-6ey6g6_606"><p>13</p></td></tr><tr id="-6ey6g6_607"><td id="-6ey6g6_608"><p>1</p></td><td id="-6ey6g6_609"><p>product 1</p></td><td id="-6ey6g6_610"><p>1</p></td><td id="-6ey6g6_611"><p>int value</p></td><td id="-6ey6g6_612"><p>2024-05-01</p></td><td id="-6ey6g6_613"><p>12</p></td></tr><tr id="-6ey6g6_614"><td id="-6ey6g6_615"><p>1</p></td><td id="-6ey6g6_616"><p>product 1</p></td><td id="-6ey6g6_617"><p>1</p></td><td id="-6ey6g6_618"><p>int value</p></td><td id="-6ey6g6_619"><p>2024-04-30</p></td><td id="-6ey6g6_620"><p>11</p></td></tr></tbody></table></div></section><section class="chapter"><h3 id="-6ey6g6_621" data-toc="-6ey6g6_621">Максимальная дата для указанного дополнительного свойства</h3><div class="code-block" data-lang="sql">
with maxtd as (select max(date_actual) as lastdt from public.productcodes where produc_id=1 and code_id=1)
select lastdt from maxtd;
</div></section><section class="chapter"><h3 id="-6ey6g6_623" data-toc="-6ey6g6_623">Актуальное на максимальную дата значение дополнительного свойства</h3><div class="code-block" data-lang="sql">
with maxtd as
    (select produc_id, code_id, max(date_actual) as lastdt
        from public.productcodes
        where produc_id=1
        group by produc_id, code_id
    )
select p.*, pc.code_id, pc.date_actual, pc.vint
from
    products p left join
        public.productcodes pc on p.id = pc.produc_id
        inner join maxtd on pc.code_id=maxtd.code_id and pc.produc_id=maxtd.produc_id
where pc.produc_id=1 and pc.code_id=1 and pc.date_actual = maxtd.lastdt;
</div></section><section class="chapter"><h3 id="-6ey6g6_625" data-toc="-6ey6g6_625">Значения всех дополнительных свойств для одного объекта</h3><div class="code-block" data-lang="sql">
with maxtd as
    (select produc_id, code_id, max(date_actual) as lastdt
        from public.productcodes
        where produc_id=1
        group by produc_id, code_id
    ),
maxtid as
    (select cn2.id, cn2.code_id from maxtd inner join public.productcodes cn2 on
    cn2.date_actual=maxtd.lastdt
    and cn2.produc_id=maxtd.produc_id
    and cn2.code_id = maxtd.code_id
              )
select coalesce(pc.produc_id, 1) as product_id, cn.kind, cn.name as codename, cn.code,
       pc.id as propid, coalesce(pc.code_id, cn.id) as code_id ,pc.date_actual,
       pc.vint, pc.vtext, pc.vdate, pc.vnum,
       pc.vmoney, pc.vjson, pc.memo as propmemo
       from
             public.productcodenames cn
                 left join maxtid on cn.id=maxtid.code_id
                 left join public.productcodes pc on maxtid.id=pc.id;
</div><p id="-6ey6g6_627">результат:</p><div class="table-wrapper"><table class="wide" id="-6ey6g6_628"><thead><tr class="ijRowHead" id="-6ey6g6_629"><th id="-6ey6g6_630"><p>product_id</p></th><th id="-6ey6g6_631"><p>kind</p></th><th id="-6ey6g6_632"><p>codename</p></th><th id="-6ey6g6_633"><p>code</p></th><th id="-6ey6g6_634"><p>propid</p></th><th id="-6ey6g6_635"><p>code_id</p></th><th id="-6ey6g6_636"><p>date_actual</p></th><th id="-6ey6g6_637"><p>vint</p></th><th id="-6ey6g6_638"><p>vtext</p></th><th id="-6ey6g6_639"><p>vdate</p></th><th id="-6ey6g6_640"><p>vnum</p></th><th id="-6ey6g6_641"><p>vmoney</p></th><th id="-6ey6g6_642"><p>vjson</p></th><th id="-6ey6g6_643"><p>propmemo</p></th></tr></thead><tbody><tr id="-6ey6g6_644"><td id="-6ey6g6_645"><p>1</p></td><td id="-6ey6g6_646"><p>5</p></td><td id="-6ey6g6_647"><p>money values</p></td><td id="-6ey6g6_648"><p>val_money</p></td><td id="-6ey6g6_649"><p>17</p></td><td id="-6ey6g6_650"><p>5</p></td><td id="-6ey6g6_651"><p>2024-05-01</p></td><td id="-6ey6g6_652"><p>null</p></td><td id="-6ey6g6_653"><p>null</p></td><td id="-6ey6g6_654"><p>null</p></td><td id="-6ey6g6_655"><p>null</p></td><td id="-6ey6g6_656"><p>35.000000</p></td><td id="-6ey6g6_657"><p>null</p></td><td id="-6ey6g6_658"><p>null</p></td></tr><tr id="-6ey6g6_659"><td id="-6ey6g6_660"><p>1</p></td><td id="-6ey6g6_661"><p>3</p></td><td id="-6ey6g6_662"><p>date value</p></td><td id="-6ey6g6_663"><p>val_date</p></td><td id="-6ey6g6_664"><p>15</p></td><td id="-6ey6g6_665"><p>3</p></td><td id="-6ey6g6_666"><p>2024-05-01</p></td><td id="-6ey6g6_667"><p>null</p></td><td id="-6ey6g6_668"><p>null</p></td><td id="-6ey6g6_669"><p>2024-04-30</p></td><td id="-6ey6g6_670"><p>null</p></td><td id="-6ey6g6_671"><p>null</p></td><td id="-6ey6g6_672"><p>null</p></td><td id="-6ey6g6_673"><p>null</p></td></tr><tr id="-6ey6g6_674"><td id="-6ey6g6_675"><p>1</p></td><td id="-6ey6g6_676"><p>4</p></td><td id="-6ey6g6_677"><p>num values</p></td><td id="-6ey6g6_678"><p>val_num</p></td><td id="-6ey6g6_679"><p>16</p></td><td id="-6ey6g6_680"><p>4</p></td><td id="-6ey6g6_681"><p>2024-05-01</p></td><td id="-6ey6g6_682"><p>null</p></td><td id="-6ey6g6_683"><p>null</p></td><td id="-6ey6g6_684"><p>null</p></td><td id="-6ey6g6_685"><p>11.025</p></td><td id="-6ey6g6_686"><p>null</p></td><td id="-6ey6g6_687"><p>null</p></td><td id="-6ey6g6_688"><p>null</p></td></tr><tr id="-6ey6g6_689"><td id="-6ey6g6_690"><p>1</p></td><td id="-6ey6g6_691"><p>6</p></td><td id="-6ey6g6_692"><p>json value</p></td><td id="-6ey6g6_693"><p>val_json</p></td><td id="-6ey6g6_694"><p>18</p></td><td id="-6ey6g6_695"><p>6</p></td><td id="-6ey6g6_696"><p>2024-05-01</p></td><td id="-6ey6g6_697"><p>null</p></td><td id="-6ey6g6_698"><p>null</p></td><td id="-6ey6g6_699"><p>null</p></td><td id="-6ey6g6_700"><p>null</p></td><td id="-6ey6g6_701"><p>null</p></td><td id="-6ey6g6_702"><p>\[&quot;test&quot;, &quot;ttest2&quot;, &quot;test3&quot;\]</p></td><td id="-6ey6g6_703"><p>null</p></td></tr><tr id="-6ey6g6_704"><td id="-6ey6g6_705"><p>1</p></td><td id="-6ey6g6_706"><p>2</p></td><td id="-6ey6g6_707"><p>text value</p></td><td id="-6ey6g6_708"><p>val_text</p></td><td id="-6ey6g6_709"><p>14</p></td><td id="-6ey6g6_710"><p>2</p></td><td id="-6ey6g6_711"><p>2024-05-01</p></td><td id="-6ey6g6_712"><p>null</p></td><td id="-6ey6g6_713"><p>value text on 0501</p></td><td id="-6ey6g6_714"><p>null</p></td><td id="-6ey6g6_715"><p>null</p></td><td id="-6ey6g6_716"><p>null</p></td><td id="-6ey6g6_717"><p>null</p></td><td id="-6ey6g6_718"><p>null</p></td></tr><tr id="-6ey6g6_719"><td id="-6ey6g6_720"><p>1</p></td><td id="-6ey6g6_721"><p>1</p></td><td id="-6ey6g6_722"><p>int value</p></td><td id="-6ey6g6_723"><p>val_int</p></td><td id="-6ey6g6_724"><p>26</p></td><td id="-6ey6g6_725"><p>1</p></td><td id="-6ey6g6_726"><p>2024-05-03</p></td><td id="-6ey6g6_727"><p>14</p></td><td id="-6ey6g6_728"><p>null</p></td><td id="-6ey6g6_729"><p>null</p></td><td id="-6ey6g6_730"><p>null</p></td><td id="-6ey6g6_731"><p>null</p></td><td id="-6ey6g6_732"><p>null</p></td><td id="-6ey6g6_733"><p>null</p></td></tr><tr id="-6ey6g6_734"><td id="-6ey6g6_735"><p>1</p></td><td id="-6ey6g6_736"><p>1</p></td><td id="-6ey6g6_737"><p>Qty</p></td><td id="-6ey6g6_738"><p>val_qty</p></td><td id="-6ey6g6_739"><p>null</p></td><td id="-6ey6g6_740"><p>7</p></td><td id="-6ey6g6_741"><p>null</p></td><td id="-6ey6g6_742"><p>null</p></td><td id="-6ey6g6_743"><p>null</p></td><td id="-6ey6g6_744"><p>null</p></td><td id="-6ey6g6_745"><p>null</p></td><td id="-6ey6g6_746"><p>null</p></td><td id="-6ey6g6_747"><p>null</p></td><td id="-6ey6g6_748"><p>null</p></td></tr></tbody></table></div></section></section><div class="last-modified">Last modified: 15 мая 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="db-design-simpleeav.html" class="navigation-links__prev">Простая реализация EVA</a><a href="db-design-trees.html" class="navigation-links__next">Деревья и иерархии</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="frontend/app.js"></script></body></html>